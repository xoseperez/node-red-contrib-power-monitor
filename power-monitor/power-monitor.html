<!--

  Copyright (c) 2018 Xose PÃ©rez <xose.perez@gmail.com>

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

-->

<script type="text/x-red" data-template-name="power-monitor">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-threshold"><i class="fa fa-thumbs-o-up"></i> Threshold</label>
        <input type="number" id="node-input-threshold" placeholder="0">
    </div>
    <div class="form-row">
        <label for="node-input-startafter"><i class="fa fa-play"></i> Start after</label>
        <input type="number" min="1" id="node-input-startafter" placeholder="1">
    </div>
    <div class="form-row">
        <label for="node-input-stopafter"><i class="fa fa-stop"></i> Stop after</label>
        <input type="number" min="1" id="node-input-stopafter" placeholder="1">
    </div>
    <div class="form-row">
        <label for="node-input-cycles"><i class="fa fa-refresh"></i> Cycles</label>
        <input type="number" min="1" id="node-input-cycles" placeholder="1">
    </div>
</script>

<script type="text/x-red" data-help-name="power-monitor">

    <p>
        A node to monitor home appliances based on their power consumption.
    </p>

    <p>
        Monitors the activity of a home appliance based on the power (W) it consumes.
        The node assumes the input value is the average power consumption since the last input. You will have to feed the node regularly (every minute, for instance).
        It will trigger an event when the appliance starts or stops (think of a washer machine, for instance) based on a power threshold and time span.
        On stop it will also append the total time and energy consumption.
        If cycles is > 1 then stop will only occur after the specified number of starts.
    </p>

    <p>
        <strong>Configuration</strong><br/>
        The output will be a JSON object with the appliance name and the event type. In case the event is a stop event it will also report the total time (in seconds) and the energy consumption of the cycle (in kWh).
        Examples:<br />
        <code>{ "name": "washer", "event": "start" }</code><br />
        <code>{ "name": "washer", "event": "stop", "time": 8800, "energy": 0.14 }</code>
    </p>

</script>

<script type="text/javascript">
    RED.nodes.registerType("power-monitor", {
        category: "analysis",
        defaults: {
            name: {value: ""},
            threshold: {value: 0},
            startafter: {value: 1},
            stopafter: {value: 1},
            cycles: {value: 1}
        },
        color:"#FFCC66",
        inputs: 1,
        outputs: 2,
        inputLabels: "power (W)",
        outputLabels: ["start event","stop event"],
        icon: "power-monitor.png",
        label: function() {
            return this.name || "power-monitor";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            this.name = this.name || "";
            this.threshold = this.threshold || 0;
            this.startafter = this.startafter || 1;
            this.stopafter = this.stopafter || 1;
            this.cycles = this.cycles || 1;
        }
    });
</script>
